// ==================== KANCHA ARENA COMPLETE SERVER ====================
// Save as: server.js
// Run command: node server.js

const express = require('express');
const path = require('path');
const fs = require('fs');

// Create server
const app = express();
const PORT = 3000;

// Middleware
app.use(express.json());
app.use(express.static('public'));

// In-memory database (temporary)
let users = [
    { id: 1, username: 'Mohammad', mobile: '9579885230', password: '123456', wallet: { deposit: 1000, winnings: 500 } }
];

let matches = [];
let transactions = [];

// ==================== API ROUTES ====================

// 1. Home Page
app.get('/', (req, res) => {
    res.send(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Kancha Arena - Server Running</title>
            <style>
                body { font-family: Arial; background: #1a1a2e; color: white; text-align: center; padding: 50px; }
                h1 { color: #e94560; }
                .box { background: #0f3460; padding: 20px; border-radius: 10px; display: inline-block; margin: 10px; }
                .btn { background: #e94560; color: white; padding: 10px 20px; border: none; border-radius: 5px; text-decoration: none; display: inline-block; margin: 10px; }
            </style>
        </head>
        <body>
            <h1>üéÆ KANCHA ARENA SERVER RUNNING!</h1>
            <div class="box">
                <h3>‚úÖ Server Status: ACTIVE</h3>
                <p>Port: ${PORT}</p>
                <p>Users Registered: ${users.length}</p>
            </div>
            <br><br>
            <a href="/game" class="btn">üéÆ PLAY GAME</a>
            <a href="/wallet" class="btn">üí∞ WALLET</a>
            <br><br>
            <div style="background: #16213e; padding: 20px; border-radius: 10px; max-width: 600px; margin: 0 auto; text-align: left;">
                <h3>üì° Available APIs:</h3>
                <p>POST /api/register - Register user</p>
                <p>POST /api/login - Login</p>
                <p>GET /api/wallet - Get balance</p>
                <p>POST /api/add-money - Add money (demo)</p>
                <p>POST /api/withdraw - Withdraw (demo)</p>
                <p>GET /api/start-match - Start match</p>
            </div>
        </body>
        </html>
    `);
});

// 2. Game Page
app.get('/game', (req, res) => {
    const gameHTML = `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Play Kancha</title>
        <style>
            body { margin: 0; background: #0f3460; color: white; font-family: Arial; }
            #gameCanvas { background: #1a1a2e; display: block; margin: 20px auto; border: 3px solid #e94560; }
            .controls { text-align: center; margin: 20px; }
            button { background: #e94560; color: white; border: none; padding: 15px 30px; margin: 10px; border-radius: 5px; font-size: 16px; cursor: pointer; }
            .wallet { background: #16213e; padding: 15px; text-align: center; }
        </style>
    </head>
    <body>
        <div class="wallet">
            <h2>üí∞ Wallet: <span id="balance">‚Çπ1500</span></h2>
            <button onclick="addMoney()">Add ‚Çπ100</button>
            <button onclick="withdraw()">Withdraw</button>
        </div>
        
        <canvas id="gameCanvas" width="800" height="500"></canvas>
        
        <div class="controls">
            <button onclick="shoot()">üéØ SHOOT KANCHA</button>
            <button onclick="findMatch()">üîç FIND MATCH (‚Çπ10)</button>
            <button onclick="location.href='/'">üè† HOME</button>
        </div>
        
        <script>
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            // Kancha
            let kancha = { x: 100, y: 250, radius: 25, color: '#e94560', speedX: 0, speedY: 0 };
            
            function draw() {
                // Clear
                ctx.fillStyle = '#1a1a2e';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Draw arena
                ctx.beginPath();
                ctx.arc(400, 250, 200, 0, Math.PI * 2);
                ctx.strokeStyle = '#3949ab';
                ctx.lineWidth = 3;
                ctx.stroke();
                
                // Draw kancha
                ctx.beginPath();
                ctx.arc(kancha.x, kancha.y, kancha.radius, 0, Math.PI * 2);
                ctx.fillStyle = kancha.color;
                ctx.fill();
                
                // Update position
                kancha.x += kancha.speedX;
                kancha.y += kancha.speedY;
                
                // Friction
                kancha.speedX *= 0.98;
                kancha.speedY *= 0.98;
                
                // Bounce
                if(kancha.x < 25 || kancha.x > 775) kancha.speedX *= -1;
                if(kancha.y < 25 || kancha.y > 475) kancha.speedY *= -1;
                
                requestAnimationFrame(draw);
            }
            
            function shoot() {
                kancha.speedX = (Math.random() - 0.5) * 20;
                kancha.speedY = (Math.random() - 0.5) * 20;
                updateWallet(50);
            }
            
            function findMatch() {
                fetch('/api/start-match', { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        alert('Match found! vs ' + data.opponent + '\\nEntry: ‚Çπ10');
                        updateWallet(-10);
                    });
            }
            
            function addMoney() {
                fetch('/api/add-money', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: 100 })
                })
                .then(res => res.json())
                .then(data => {
                    alert('‚Çπ100 added! New balance: ‚Çπ' + data.balance);
                    document.getElementById('balance').textContent = '‚Çπ' + data.balance;
                });
            }
            
            function withdraw() {
                let amount = prompt('Enter amount to withdraw:');
                if(amount && amount > 0) {
                    fetch('/api/withdraw', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ amount: amount, upi: 'user@upi' })
                    })
                    .then(res => res.json())
                    .then(data => {
                        alert(data.message);
                        document.getElementById('balance').textContent = '‚Çπ' + data.balance;
                    });
                }
            }
            
            function updateWallet(amount) {
                fetch('/api/add-money', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: amount })
                })
                .then(res => res.json())
                .then(data => {
                    document.getElementById('balance').textContent = '‚Çπ' + data.balance;
                });
            }
            
            draw();
        </script>
    </body>
    </html>
    `;
    res.send(gameHTML);
});

// 3. Wallet Page
app.get('/wallet', (req, res) => {
    res.send(`
    <!DOCTYPE html>
    <html>
    <head>
        <title>Wallet</title>
        <style>
            body { font-family: Arial; background: #1a1a2e; color: white; padding: 40px; }
            .container { max-width: 500px; margin: 0 auto; }
            .card { background: #0f3460; padding: 30px; border-radius: 10px; margin: 20px 0; }
            input, button { width: 100%; padding: 15px; margin: 10px 0; border-radius: 5px; }
            input { border: 2px solid #3949ab; background: #16213e; color: white; }
            button { background: #e94560; color: white; border: none; cursor: pointer; }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>üí∞ KANCHA WALLET</h1>
            
            <div class="card">
                <h2>Current Balance: <span id="bal">‚Çπ1500</span></h2>
                <p>Deposit: ‚Çπ1000 | Winnings: ‚Çπ500</p>
            </div>
            
            <div class="card">
                <h3>Add Money</h3>
                <input type="number" id="amount" placeholder="Enter amount" value="100">
                <button onclick="addMoney()">Add to Wallet</button>
            </div>
            
            <div class="card">
                <h3>Withdraw to UPI</h3>
                <input type="text" id="upi" placeholder="Enter UPI ID" value="mohammad@okicici">
                <input type="number" id="wamount" placeholder="Amount" value="100">
                <button onclick="withdraw()">Withdraw</button>
                <p style="color: #ff9800; font-size: 12px;">Minimum ‚Çπ100 | TDS 30% on winnings above ‚Çπ10,000/year</p>
            </div>
            
            <button onclick="location.href='/game'" style="background: #3949ab;">üéÆ Back to Game</button>
        </div>
        
        <script>
            function addMoney() {
                let amount = document.getElementById('amount').value;
                fetch('/api/add-money', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseInt(amount) })
                })
                .then(res => res.json())
                .then(data => {
                    alert('Success! New balance: ‚Çπ' + data.balance);
                    document.getElementById('bal').textContent = '‚Çπ' + data.balance;
                });
            }
            
            function withdraw() {
                let amount = document.getElementById('wamount').value;
                let upi = document.getElementById('upi').value;
                
                fetch('/api/withdraw', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount: parseInt(amount), upi: upi })
                })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    document.getElementById('bal').textContent = '‚Çπ' + data.balance;
                });
            }
        </script>
    </body>
    </html>
    `);
});

// ==================== APIs ====================

// Register
app.post('/api/register', (req, res) => {
    const { username, mobile, password } = req.body;
    const newUser = {
        id: users.length + 1,
        username,
        mobile,
        password,
        wallet: { deposit: 0, winnings: 0 }
    };
    users.push(newUser);
    res.json({ success: true, message: 'Registration successful', userId: newUser.id });
});

// Login
app.post('/api/login', (req, res) => {
    const { mobile, password } = req.body;
    const user = users.find(u => u.mobile === mobile && u.password === password);
    if(user) {
        res.json({ success: true, user: { id: user.id, username: user.username, wallet: user.wallet } });
    } else {
        res.json({ success: false, message: 'Invalid credentials' });
    }
});

// Get Wallet
app.post('/api/wallet', (req, res) => {
    const { userId } = req.body;
    const user = users.find(u => u.id === userId);
    res.json({ balance: user ? user.wallet.deposit + user.wallet.winnings : 0 });
});

// Add Money (DEMO - no real payment)
app.post('/api/add-money', (req, res) => {
    const { amount, userId = 1 } = req.body;
    const user = users.find(u => u.id === userId);
    if(user) {
        user.wallet.deposit += parseInt(amount);
        res.json({ success: true, balance: user.wallet.deposit + user.wallet.winnings, message: `‚Çπ${amount} added` });
    } else {
        res.json({ success: false, message: 'User not found' });
    }
});

// Withdraw (DEMO)
app.post('/api/withdraw', (req, res) => {
    const { amount, upi, userId = 1 } = req.body;
    const user = users.find(u => u.id === userId);
    
    if(!user) {
        return res.json({ success: false, message: 'User not found' });
    }
    
    const total = user.wallet.deposit + user.wallet.winnings;
    if(total < amount) {
        return res.json({ success: false, message: 'Insufficient balance' });
    }
    
    if(amount < 100) {
        return res.json({ success: false, message: 'Minimum withdrawal ‚Çπ100' });
    }
    
    // Deduct from winnings first
    let remaining = amount;
    if(user.wallet.winnings >= remaining) {
        user.wallet.winnings -= remaining;
    } else {
        remaining -= user.wallet.winnings;
        user.wallet.winnings = 0;
        user.wallet.deposit -= remaining;
    }
    
    transactions.push({
        id: transactions.length + 1,
        userId,
        type: 'withdrawal',
        amount,
        upi,
        status: 'completed',
        date: new Date()
    });
    
    res.json({ 
        success: true, 
        message: `Withdrawal request for ‚Çπ${amount} to ${upi} submitted successfully!`,
        balance: user.wallet.deposit + user.wallet.winnings
    });
});

// Start Match
app.post('/api/start-match', (req, res) => {
    const opponents = ['Rahul', 'Priya', 'Amit', 'Sneha', 'Vikram'];
    const opponent = opponents[Math.floor(Math.random() * opponents.length)];
    
    matches.push({
        id: matches.length + 1,
        players: ['Mohammad', opponent],
        entryFee: 10,
        status: 'ongoing',
        startTime: new Date()
    });
    
    res.json({ success: true, opponent, matchId: matches.length });
});

// Start Server
app.listen(PORT, () => {
    console.log(`
    ============================================
    üéÆ KANCHA ARENA SERVER STARTED SUCCESSFULLY!
    ============================================
    
    ‚úÖ Server running at: http://localhost:${PORT}
    
    üì° Available Pages:
    - Home:      http://localhost:${PORT}
    - Game:      http://localhost:${PORT}/game
    - Wallet:    http://localhost:${PORT}/wallet
    
    üîß APIs:
    - POST /api/register
    - POST /api/login  
    - POST /api/add-money
    - POST /api/withdraw
    - POST /api/start-match
    
    üíæ Users in database: ${users.length}
    ============================================
    `);
});
